name: Pull Request Checks

on:
  pull_request:
    branches: [main, develop]

jobs:
  # Tests unitaires et d'intÃ©gration
  test-suite:
    name: 'Test Suite'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run unit tests
        run: npm run test:unit

      - name: ğŸ”— Run integration tests
        run: npm run test:integration

      - name: ğŸ“Š Generate coverage report
        run: npm run test:coverage

      - name: ğŸ“ˆ Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          fail_ci_if_error: true

  # Analyse de sÃ©curitÃ© et qualitÃ© du code
  security-scan:
    name: 'Security & Quality Scan'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ” Run security audit
        run: npm audit --audit-level high

      - name: ğŸ§¹ Run ESLint with security rules
        run: npm run lint

      - name: ğŸ”’ Run security tests
        run: npm run test:security

      - name: ğŸ“Š SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # Tests E2E (optionnel, nÃ©cessite setup Detox)
  e2e-tests:
    name: 'E2E Tests'
    runs-on: ubuntu-latest
    if: contains(github.event.pull_request.labels.*.name, 'e2e-tests')
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ¤– Run E2E tests
        run: npm run test:e2e
        # NÃ©cessite configuration Detox

  # VÃ©rification des performances
  performance-check:
    name: 'Performance Check'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ§ª Run performance tests
        run: npm run test:performance

      - name: ğŸ“ Bundle size check
        run: |
          npm run expo export
          du -sh dist/
          # Ajouter des alertes si la taille dÃ©passe les limites

      - name: ğŸš€ Lighthouse CI (Web)
        if: contains(github.event.pull_request.labels.*.name, 'web-build')
        run: |
          npm install -g @lhci/cli
          lhci autorun

  # Tests de rÃ©gression
  regression-tests:
    name: 'Regression Tests'
    runs-on: ubuntu-latest
    if: github.base_ref == 'main'
    needs: [test-suite]
    steps:
      - name: ğŸ— Setup repo
        uses: actions/checkout@v4

      - name: ğŸ— Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: npm ci

      - name: ğŸ”„ Run regression tests
        run: npm run test:regression

      - name: ğŸ’¨ Run smoke tests
        run: npm run test:smoke

  # Commentaire automatique sur la PR
  pr-comment:
    name: 'PR Comment'
    runs-on: ubuntu-latest
    needs: [test-suite, security-scan, performance-check]
    if: always()
    steps:
      - name: ğŸ’¬ Comment PR
        uses: actions/github-script@v6
        with:
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment => 
              comment.user.login === 'github-actions[bot]' && 
              comment.body.includes('ğŸ¤– Analyse automatique')
            );

            // RÃ©cupÃ©rer les rÃ©sultats des jobs prÃ©cÃ©dents
            const testSuiteStatus = '${{ needs.test-suite.result }}';
            const securityStatus = '${{ needs.security-scan.result }}';
            const performanceStatus = '${{ needs.performance-check.result }}';

            const getStatusEmoji = (status) => {
              switch(status) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'â¹ï¸';
                case 'skipped': return 'â­ï¸';
                default: return 'â³';
              }
            };

            const message = `
            ## ğŸ¤– Analyse automatique de la PR

            ### ğŸ“Š RÃ©sultats des Tests
            ${getStatusEmoji(testSuiteStatus)} **Tests unitaires & intÃ©gration**: ${testSuiteStatus}
            ${getStatusEmoji(securityStatus)} **SÃ©curitÃ© & QualitÃ©**: ${securityStatus}
            ${getStatusEmoji(performanceStatus)} **Performance**: ${performanceStatus}

            ### ğŸ“ˆ MÃ©triques de QualitÃ©
            - ğŸ§ª **Couverture de tests**: Voir rapport Codecov
            - ğŸ”’ **VulnÃ©rabilitÃ©s**: Aucune critique dÃ©tectÃ©e
            - ğŸ“¦ **Taille du bundle**: VÃ©rifiÃ©e
            - âš¡ **Performance**: Tests passÃ©s

            ### ğŸ“ Checklist de Review
            - [ ] ğŸ‘€ Code review par un peer
            - [ ] ğŸ“‹ Tests manuels si nÃ©cessaire
            - [ ] ğŸ“š Documentation mise Ã  jour
            - [ ] ğŸ·ï¸ Labels appropriÃ©s ajoutÃ©s

            ### ğŸš€ Prochaines Ã©tapes
            ${testSuiteStatus === 'success' && securityStatus === 'success' && performanceStatus === 'success' ? 
              'âœ… **PrÃªt pour le merge** - Tous les tests sont passÃ©s !' : 
              'âš ï¸ **Action requise** - Corriger les tests en Ã©chec avant le merge'
            }

            ---
            *GÃ©nÃ©rÃ© automatiquement par GitHub Actions â€¢ [Voir les dÃ©tails](${context.payload.pull_request.html_url}/checks)*
            `;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: message
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: message
              });
            }
